<!DOCTYPE html>
<html lang="kk" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dr. Gulmira Sarsenbekovna | Денсаулық орталығы</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300..900&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0e9f6e" />
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="apple-mobile-web-app-title" content="Dr. Gulmira"/>
  <link rel="apple-touch-icon" href="/icons/180.png"/>
  <link rel="apple-touch-icon" href="logo.jpeg"/>

  <style>
    /* =============== Design System =============== */
    :root{
      --bg:#0f1420;             /* dark base (used in dark theme) */
      --ink:#0b1220;            /* headings in light */
      --text:#3b4152;           /* body text */
      --muted:#7c839a;
      --line:#e8eaf1;

      --card:#ffffff;
      --panel:#f7f8fc;
      --soft:#f2f5ff;

      --brand:#dc00b7;
      --brand-2:#984881;
      --accent:#ff3a3a;

      --ok:#19C37D; --warn:#F5B400; --bad:#E53E3E;

      --r:16px; --r-lg:20px;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --shadow-lg:0 18px 45px rgba(0,0,0,.14);
      --ease: cubic-bezier(.2,.7,.2,1);

      --container:1280px;

      /* Gradients */
      --grad-brand: linear-gradient(135deg, #e45df8 0%, #ff4cdb 100%);
      --grad-accent: linear-gradient(135deg, #f53aff 0%, #b625eb 100%);
      --grad-green: linear-gradient(135deg, #c24ab6 0%, #d72ca4 100%);
      --grad-hero: linear-gradient(135deg, #7e0077ea 0%, #000000 100%);
    }

    html { scroll-behavior:smooth; }
    * { box-sizing: border-box; }
    body{
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin:0; color:var(--text); background:#f8fafc; line-height:1.6;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }

    .container{ width:100%; max-width:var(--container); margin:0 auto; padding:0 24px; }

    /* Header */
    header{
      position:sticky; top:0; z-index:1000; backdrop-filter: blur(10px);
      background: rgba(255,255,255,.95); border-bottom:1px solid rgba(0,0,0,.04);
      box-shadow: 0 2px 20px rgba(0,0,0,.05);
    }
    .navbar{ display:flex; align-items:center; gap:20px; padding:14px 0; }
    .logo{ display:flex; align-items:center; gap:12px; text-decoration:none; color:var(--ink); font-weight:800; font-size:1.25rem; }
    .logo img{ width:48px; height:48px; object-fit:cover; border-radius:50%; border:3px solid var(--brand); box-shadow:0 4px 15px rgba(14,159,110,.2); }
    .nav-links{ display:flex; gap:18px; margin-left:20px; }
    .nav-links a{ position:relative; text-decoration:none; color:var(--text); font-weight:500; padding:8px 10px; border-radius:10px; transition:all 0.3s ease; }
    .nav-links a:hover{ color:var(--brand); transform:translateY(-2px); }
    .user-actions{ margin-left:auto; display:flex; gap:12px; align-items:center; }
    .chip{ display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:12px; background:rgba(14,159,110,.08); }
    .chip i{ color:#fff; background:var(--grad-green); width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:8px; }
    .btn{ display:inline-flex; align-items:center; gap:10px; padding:12px 18px; border:0; border-radius:12px; font-weight:600; cursor:pointer; text-decoration:none; transition: transform .2s var(--ease), box-shadow .2s var(--ease), opacity .2s var(--ease); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn-primary{ background:var(--grad-brand); color:#fff; box-shadow: var(--shadow); }
    .btn-outline{ border:2px solid var(--brand); color:var(--brand); background:transparent; }
    .btn-soft{ background:rgba(14,159,110,.08); color:var(--brand); }
    .btn-accent{ background:var(--grad-accent); color:#fff; }
    .btn-green{ background:var(--grad-green); color:#fff; }

    /* Pages */
    .page{ display:none; opacity:0; transform: translateY(12px); transition: all .35s var(--ease); }
    .page.active{ display:block; opacity:1; transform:none; }

    /* Hero */
    .hero{
      position:relative; overflow:hidden; padding:120px 0 80px; text-align:center;
      background: linear-gradient(135deg, #f1f9f6 0%, #e8f4f1 50%, #dff0ea 100%);
    }
    .hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none"><defs><pattern id="dots" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="2" cy="2" r="1" fill="%230e9f6e" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
      opacity: 0.3;
    }
    .hero h1{
      margin:0 0 18px; font-size: clamp(28px, 5vw, 56px); font-weight:900; letter-spacing:-.02em;
      background: var(--grad-hero); -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .hero p{ color:var(--muted); font-size: clamp(16px, 2.5vw, 20px); max-width:740px; margin:0 auto 28px; font-weight:500; }

    /* Doctor Badge */
    .doctor-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.9);
      padding: 10px 20px;
      border-radius: 50px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      border: 1px solid rgba(14,159,110,0.2);
    }
    .doctor-badge i {
      color: var(--brand);
      font-size: 1.2rem;
    }
    .doctor-badge span {
      font-weight: 700;
      color: var(--brand);
    }

    /* Sections */
    .section{ padding:60px 0; }
    .section-title{ text-align:center; margin-bottom:28px; }
    .section-title h2{ font-size: clamp(22px, 3.5vw, 36px); color:var(--ink); margin:0 0 8px; font-weight:800; letter-spacing:-.01em; }
    .section-title p{ color:var(--muted); margin:0 auto; max-width:740px; }

    /* Cards */
    .grid{ display:grid; gap:22px; }
    .grid.modules{ grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius: var(--r-lg);
      box-shadow: var(--shadow); overflow:hidden; display:flex; flex-direction:column;
      transition: transform .25s var(--ease), box-shadow .25s var(--ease);
    }
    .card:hover{ transform: translateY(-6px); box-shadow: var(--shadow-lg); }
    .card-h{ 
      position:relative; 
      height:220px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      background-size: cover;
      background-position: center;
      overflow: hidden;
    }
    .card-h::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.3));
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .card:hover .card-h::after {
      opacity: 1;
    }
    .module-tag{
      position:absolute; top:14px; left:14px; background:var(--grad-brand); color:#fff;
      padding:8px 12px; border-radius:999px; font-weight:700; font-size:.9rem;
      z-index: 2;
    }
    .card-b{ padding:22px; display:flex; flex-direction:column; gap:14px; }
    .card-b h3{ margin:0; color:#20253b; font-size:1.15rem; font-weight:800; letter-spacing:-.01em; }
    .card-b p{ margin:0; color:var(--muted); line-height:1.7; }
    .meta{ display:flex; gap:12px; align-items:center; color:var(--brand); font-weight:700; }

    /* Lesson card */
    .lesson-num{
      position:absolute; width:84px; height:84px; border-radius:50%;
      display:flex; align-items:center; justify-content:center; font-weight:900; font-size:1.6rem; color:#fff;
      background: var(--grad-brand); box-shadow: var(--shadow);
      z-index: 2;
    }

    /* Payment */
    .pay-wrap{ max-width:760px; margin:0 auto; background:var(--card); border:1px solid var(--line); border-radius:var(--r-lg); padding:32px; box-shadow:var(--shadow); }
    .steps{ display:flex; gap:16px; align-items:center; justify-content:center; margin:20px 0 28px; position:relative; }
    .steps::before{ content:''; position:absolute; top:24px; left:10%; right:10%; height:3px; background:#edf0f6; }
    .step{ z-index:1; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .step-badge{ width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#edf0f6; color:#8a91a7; font-weight:800; }
    .step.active .step-badge{ background: var(--grad-brand); color:#fff; }
    .info{ display:grid; grid-template-columns:1fr 1fr; gap:14px 22px; background:#fafbff; border:1px dashed #dfe4f2; border-radius:16px; padding:18px; }
    .info .k{ color:var(--muted); } .info .v{ color:#1f2545; font-weight:700; }
    .upload{ border:2px dashed #dfe4f2; border-radius:16px; padding:32px; text-align:center; cursor:pointer; transition:all 0.3s ease; }
    .upload:hover{ border-color:var(--brand); background:rgba(14,159,110,.03); transform:translateY(-2px); }

    /* Footer */
    footer{ margin-top:60px; padding:60px 0 28px; color:#fff; background: linear-gradient(135deg, #151a33 0%, #0b0f22 100%); }
    .f-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:28px; }
    .f-title{ font-weight:800; font-size:1.25rem; margin-bottom:12px; }
    .f-links{ list-style:none; padding:0; margin:0; display:grid; gap:10px; }
    .f-links a{ color:rgba(255,255,255,.9); text-decoration:none; transition:color 0.3s ease; }
    .f-links a:hover{ color:var(--brand); text-decoration:none; }
    .social{ display:flex; gap:10px; }
    .social a{ width:42px; height:42px; display:grid; place-items:center; border-radius:12px; background:rgba(255,255,255,.12); color:#fff; transition:all 0.3s ease; }
    .social a:hover{ background:var(--brand); transform:translateY(-2px); }

    /* Modal */
    .modal{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.6); backdrop-filter: blur(6px); z-index:2000; opacity:0; visibility:hidden; transition: all .3s var(--ease); }
    .modal.active{ opacity:1; visibility:visible; }
    .modal-card{ width:min(94vw,460px); background:#fff; border-radius:20px; box-shadow: var(--shadow-lg); padding:28px; transform: translateY(8px) scale(.98); transition: all .35s var(--ease); }
    .modal.active .modal-card{ transform:none; }
    .modal-h{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .x{ background:transparent; border:0; font-size:22px; color:#8a91a7; cursor:pointer; transition:color 0.3s ease; }
    .x:hover{ color:var(--brand); }

    .field{ display:grid; gap:8px; margin:14px 0; }
    .label{ font-weight:700; color:#20253b; }
    .input{ height:46px; border:1px solid #e5e9f5; border-radius:12px; padding:0 14px; font: inherit; background:#f8faff; transition:all 0.3s ease; }
    .input:focus{ outline: 3px solid rgba(14,159,110,.25); background:#fff; border-color:var(--brand); }

    /* Notifications */
    .toast{
      position:fixed; top:22px; right:22px; z-index:3000; display:flex; align-items:center; gap:12px;
      padding:12px 16px; color:#fff; border-radius:12px; box-shadow: var(--shadow-lg); transform: translateX(140%); transition: transform .35s var(--ease);
    }
    .toast.in{ transform:none; }
    .toast.info{ background:#4299e1; } .toast.success{ background:#19c37d; } .toast.error{ background:#e53e3e; }

    /* Video Page */
    .video-wrap{ max-width:980px; margin:0 auto; display:grid; gap:18px; }
    .video-box{ position:relative; width:100%; padding-bottom:56.25%; height:0; border-radius:16px; overflow:hidden; background:#000; box-shadow: var(--shadow); }
    .video-box iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; }
    .v-head{ display:block; align-items:center; gap:12px; justify-content:space-between; }
    .v-title{ font-weight:900; letter-spacing:-.01em; color:#20253b; font-size: clamp(18px, 3vw, 26px); margin:0; }
    .v-desc{ color:var(--muted); margin:0; }
    .v-nav{ display:block; gap:10px; align-items:center; }
    .v-nav .btn{ min-width:130px; }

    .comments{ background:#fff; border:1px solid var(--line); border-radius:16px; padding:18px; display:grid; gap:12px; }
    .comment{ padding:12px; background:#fbfcff; border-left:4px solid var(--brand-2); border-radius:12px; transition:transform 0.3s ease; }
    .comment:hover{ transform:translateX(4px); }
    .comment .a{ font-weight:800; color:#1f2545; margin-bottom:6px; display:flex; gap:8px; align-items:center; }
    .comment .t{ color:#3b4152; }
    .c-new textarea{ width:100%; min-height:90px; border-radius:12px; border:1px solid #e5e9f5; padding:12px; background:#f8faff; font: inherit; transition:all 0.3s ease; }
    .c-new textarea:focus{ outline: 3px solid rgba(14,159,110,.25); background:#fff; border-color:var(--brand); }

    /* Public comments grid */
    .pub-comments{ display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap:16px; }
    .pub-comments .comment{ background:#fff; }

    /* Mobile fullscreen fix for the lesson page if opened standalone on phones */
    .vh-100{ height: 100dvh; }

    /* Floating refresh */
    .fab-refresh{
      position: fixed;
      right: max(16px, env(safe-area-inset-right));
      bottom: max(16px, env(safe-area-inset-bottom));
      width:56px; height:56px; border:0; border-radius:999px;
      background:var(--grad-brand); color:#fff; display:grid; place-items:center;
      box-shadow: var(--shadow-lg); z-index:2500; cursor:pointer;
      transition: transform .2s var(--ease), box-shadow .2s var(--ease), opacity .2s var(--ease);
    }
    .fab-refresh:hover{ transform: translateY(-2px) scale(1.05); }
    .fab-refresh.spin i{ animation: spin .8s linear infinite; }
    @keyframes spin { to{ transform: rotate(360deg); } }

    /* Specialties Grid */
    .specialties-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .specialty-card {
      background: white;
      padding: 25px;
      border-radius: 16px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      border: 1px solid var(--line);
    }
    .specialty-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    .specialty-icon {
      width: 70px;
      height: 70px;
      margin: 0 auto 15px;
      background: var(--grad-brand);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
    }

    /* Responsive */
    @media (max-width: 768px){
      .nav-links{ display:none; }
      .steps{ flex-direction:column; gap:18px; }
      .steps::before{ display:none; }
      .info{ grid-template-columns:1fr; }
      .v-nav .btn{ min-width:unset; flex:1; justify-content:center; }
      .specialties-grid { grid-template-columns: 1fr; }
    }

    /* ===== Global Loader Overlay ===== */
.loader {
  position: fixed; inset: 0;
  display: grid; place-items: center;
  background: rgba(255,255,255,.85);
  backdrop-filter: blur(6px);
  z-index: 4000;
  opacity: 0; visibility: hidden;
  transition: opacity .25s var(--ease), visibility .25s var(--ease);
}
.loader.in { opacity: 1; visibility: visible; }
.loader .box {
  display: grid; gap: 12px; place-items: center;
  padding: 18px 22px; border-radius: 16px;
  background: #fff; border: 1px solid var(--line); box-shadow: var(--shadow-lg);
  color: #20253b; font-weight: 800;
}
.loader .spin {
  width: 34px; height: 34px; border-radius: 50%;
  border: 3px solid #e8ecf7; border-top-color: #0e9f6e;
  animation: loaderSpin .8s linear infinite;
}
@keyframes loaderSpin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="app">
    <!-- ======================== Main Page ======================== -->
    <div id="page-home" class="page active" role="region" aria-label="Басты бет">
      <header>
        <div class="container">
          <nav class="navbar" aria-label="Жоғарғы навигация">
            <a href="#/" class="logo">
              <div style="width:48px;height:48px;border-radius:50%;background:var(--grad-brand);display:flex;align-items:center;justify-content:center;color:white;">
                <i class="fas fa-user-md"></i>
              </div>
              <span>Dr. Gulmira Sarsenbekovna</span>
            </a>
            <div class="nav-links" role="navigation">
              <a href="#/" aria-current="page">Басты бет</a>
              <a href="#/modules">Қызметтер</a>
              <a href="#/about">Мен туралы</a>
              <a href="#/contacts">Байланыс</a>
            </div>
            <div class="user-actions">
              <div id="chipUser" class="chip" style="display:none"><i class="fas fa-user"></i><b id="chipName">Пайдаланушы</b></div>
              <button id="btnLogin" class="btn btn-outline"><i class="fas fa-sign-in-alt"></i> Кіру</button>
            </div>
          </nav>
        </div>
      </header>

      <section class="hero">
        <div class="container">
          <div class="doctor-badge">
            <i class="fas fa-stethoscope"></i>
            <span>35 жылдық тәжірибесі бар дәрігер</span>
          </div>
          <h1>ДЕНСАУЛЫҚ - СІЗДІҢ ЕН ҮЛКЕН БАЙЛЫҒЫҢЫЗ</h1>
          <h1>Гирудотерапия және массаж</h1>
          <p>Денсаулығыңызды жақсартуға арналған дәстүрлі және заманауи әдістер</p>
          <a class="btn btn-green" href="#/modules"><i class="fas fa-calendar-check"></i> Консультацияға жазылу</a>
          <button id="btnInstall" class="btn btn-soft" style="margin-left:10px; display:none;"><i class="fas fa-download"></i> Қолданбаны орнату</button>
        </div>
      </section>

      <section class="section">
        <div class="container">
          <div class="section-title">
            <h2>Менің мамандықтарым</h2>
            <p>35 жылдық тәжірибем бойынша ұсынатын негізгі қызметтер</p>
          </div>
          <div class="specialties-grid">
            <div class="specialty-card">
              <div class="specialty-icon">
                <i class="fas fa-hand-holding-medical"></i>
              </div>
              <h3>Гирудотерапия</h3>
              <p>Емдік сүліктермен емдеу - дененің жалпы жағдайын жақсартудың тиімді әдісі</p>
            </div>
            <div class="specialty-card">
              <div class="specialty-icon">
                <i class="fas fa-hands"></i>
              </div>
              <h3>Точечный массаж</h3>
              <p>Белгілі бір нүктелерге әсер ету арқылы ағзаның жұмысын қалпына келтіру</p>
            </div>
            <div class="specialty-card">
              <div class="specialty-icon">
                <i class="fas fa-stomach"></i>
              </div>
              <h3>Висцеральный массаж</h3>
              <p>Ішкі ағзаларға арналған массаж - денені ішкі деңгейде емдеу</p>
            </div>
            <div class="specialty-card">
              <div class="specialty-icon">
                <i class="fas fa-spa"></i>
              </div>
              <h3>Телесная практика</h3>
              <p>Дене мен ақыл-естің үйлесімділігін қалпына келтіруге бағытталған практикалар</p>
            </div>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="container">
          <div class="section-title">
            <h2>Білім модульдері</h2>
            <p>Денсаулығыңыз туралы білім алып, өз өміріңізді жақсартыңыз</p>
          </div>
          <div id="modulesGrid" class="grid modules" aria-live="polite">
            <div class="card" style="padding:30px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> Модульдер жүктелуде…</div>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="container">
          <div class="section-title"><h2>Науқастардың пікірлері</h2></div>
          <div id="publicComments" class="pub-comments" aria-live="polite">
            <div class="card" style="padding:30px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> Пікірлер жүктелуде…</div>
          </div>
        </div>
      </section>

      <footer>
        <div class="container">
          <div class="f-grid">
            <div>
              <div class="f-title">Dr. Gulmira Sarsenbekovna</div>
              <p>35 жылдық тәжірибесі бар телесный практик. Гирудотерапия, массаж және денсаулықты қалпына келтіру бойынша маман.</p>
              <div class="social" style="margin-top:10px;">
                <a href="https://www.instagram.com/dr.gulmira_sarsenbekovna?igsh=MWNneWg0NWY1dG9jbA%3D%3D&utm_source=qr" target="_blank" rel="noopener" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="https://wa.me/77778874427" target="_blank" rel="noopener" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
              </div>
            </div>
            <div>
              <div class="f-title">Бөлімдер</div>
              <ul class="f-links">
                <li><a href="#/">Басты бет</a></li>
                <li><a href="#/modules">Қызметтер</a></li>
                <li><a href="#/about">Мен туралы</a></li>
                <li><a href="#/contacts">Консультация</a></li>
              </ul>
            </div>
            <div>
              <div class="f-title">Байланыс</div>
              <ul class="f-links">
                <li><a href="https://wa.me/77778874427" target="_blank" rel="noopener">WhatsApp: +7 777 887 44 27</a></li>
                <li><a href="https://www.instagram.com/dr.gulmira_sarsenbekovna?igsh=MWNneWg0NWY1dG9jbA%3D%3D&utm_source=qr" target="_blank" rel="noopener">Instagram</a></li>
                <li>Bilis Nurpeisova 16, Kyzylorda 120008</li>
              </ul>
            </div>
          </div>
          <div style="text-align:center; margin-top:22px; opacity:.85;">&copy; 2025 Dr. Gulmira Sarsenbekovna. Барлық құқықтар қорғалған.</div>
        </div>
      </footer>
    </div>

    <!-- ======================== Lessons Page (list) ======================== -->
    <div id="page-lessons" class="page" role="region" aria-label="Сабақтар тізімі">
      <header>
        <div class="container">
          <nav class="navbar">
            <a href="#/" class="logo"><i class="fas fa-arrow-left"></i><span> Артқа</span></a>
            <div class="nav-links"></div>
            <div class="user-actions">
              <div id="chipUser2" class="chip" style="display:none"><i class="fas fa-user"></i><b id="chipName2">Пайдаланушы</b></div>
              <button id="btnLogin2" class="btn btn-outline"><i class="fas fa-sign-in-alt"></i> Кіру</button>
            </div>
          </nav>
        </div>
      </header>

      <section class="section">
        <div class="container">
          <div class="section-title">
            <h2 id="lessonsModuleTitle">Модуль сабақтары</h2>
            <p id="lessonsModuleDesc">Оқу үшін сабақты таңдаңыз</p>
          </div>
          <div id="lessonsGrid" class="grid modules" aria-live="polite">
            <div class="card" style="padding:30px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> Сабақтар жүктелуде…</div>
          </div>
        </div>
      </section>

      <footer>
        <div class="container">
          <div class="f-grid">
            <div>
              <div class="f-title">Dr. Gulmira Sarsenbekovna</div>
              <p>35 жылдық тәжірибесі бар телесный практик. Гирудотерапия, массаж және денсаулықты қалпына келтіру бойынша маман.</p>
              <div class="social" style="margin-top:10px;">
                <a href="https://www.instagram.com/dr.gulmira_sarsenbekovna?igsh=MWNneWg0NWY1dG9jbA%3D%3D&utm_source=qr" target="_blank" rel="noopener"><i class="fab fa-instagram"></i></a>
                <a href="https://wa.me/77778874427" target="_blank" rel="noopener"><i class="fab fa-whatsapp"></i></a>
              </div>
            </div>
            <div>
              <div class="f-title">Бөлімдер</div>
              <ul class="f-links">
                <li><a href="#/">Басты бет</a></li>
                <li><a href="#/modules">Қызметтер</a></li>
                <li><a href="#/about">Мен туралы</a></li>
                <li><a href="#/contacts">Консультация</a></li>
              </ul>
            </div>
            <div>
              <div class="f-title">Байланыс</div>
              <ul class="f-links">
                <li><a href="https://wa.me/77778874427" target="_blank" rel="noopener">WhatsApp: +7 777 887 44 27</a></li>
                <li><a href="https://www.instagram.com/dr.gulmira_sarsenbekovna?igsh=MWNneWg0NWY1dG9jbA%3D%3D&utm_source=qr" target="_blank" rel="noopener">Instagram</a></li>
                <li>Bilis Nurpeisova 16, Kyzylorda 120008</li>
              </ul>
            </div>
          </div>
          <div style="text-align:center; margin-top:22px; opacity:.85;">&copy; 2025 Dr. Gulmira Sarsenbekovna. Барлық құқықтар қорғалған.</div>
        </div>
      </footer>
    </div>

    <!-- ======================== Lesson View (single) ======================== -->
    <div id="page-lesson" class="page" role="region" aria-label="Сабақ экраны">
      <header>
        <div class="container">
          <nav class="navbar">
            <a id="linkBackToLessons" href="#/" class="logo"><i class="fas fa-arrow-left"></i><span> Артқа</span></a>
            <div class="user-actions">
              <div id="chipUser3" class="chip" style="display:none"><i class="fas fa-user"></i><b id="chipName3">Пайдаланушы</b></div>
              <button id="btnLogin3" class="btn btn-outline"><i class="fas fa-sign-in-alt"></i> Кіру</button>
            </div>
          </nav>
        </div>
      </header>

      <section class="section">
        <div class="container">
          <div class="video-wrap">
            <div class="v-head">
              <div>
                <h1 id="lessonTitle" class="v-title">Сабақ</h1>
                <p id="lessonDesc" class="v-desc"></p>
              </div>
              <div class="v-nav">
                <a id="btnPdf" class="btn btn-soft" href="#" target="_blank" rel="noopener" style="display:none;"><i class="fas fa-file-pdf"></i> Презентация</a>
                <a id="btnExternal" class="btn btn-soft" href="#" target="_blank" rel="noopener" style="display:none;"><i class="fas fa-external-link-alt"></i> Ашып көру</a>
              </div>
            </div>

            <div class="video-box">
              <iframe id="lessonFrame" allow="autoplay; encrypted-media; picture-in-picture; fullscreen" allowfullscreen webkitallowfullscreen mozallowfullscreen playsinline></iframe>
            </div>

            <div class="v-nav">
              <button id="btnPrev" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Алдыңғы</button>
              <button id="btnNext" class="btn btn-primary">Келесі <i class="fas fa-arrow-right"></i></button>
            </div>

            <div class="comments">
              <div id="commentsList" aria-live="polite"></div>
              <div id="newComment" class="c-new" style="display:none;">
                <textarea id="commentInput" placeholder="Пікір қалдыру..." aria-label="Комментарий"></textarea>
                <div style="display:flex; gap:10px; margin-top:10px;">
                  <button id="sendComment" class="btn btn-green"><i class="fas fa-paper-plane"></i> Жіберу</button>
                </div>
              </div>
              <div id="needLogin" style="display:none; color:#7c839a;">Пікір қалдыру үшін жүйеге кіріңіз.</div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- ======================== Payment Page ======================== -->
    <div id="page-payment" class="page" role="region" aria-label="Төлем беті">
      <header>
        <div class="container">
          <nav class="navbar">
            <a href="#/" class="logo"><i class="fas fa-arrow-left"></i><span> Артқа</span></a>
            <div class="nav-links"></div>
          </nav>
        </div>
      </header>

      <section class="section vh-100" style="display:grid; place-items:center;">
        <div class="container">
          <div class="pay-wrap">
            <div style="text-align:center;">
              <div style="font-size:48px; line-height:0; margin-bottom:14px; background:var(--grad-green); -webkit-background-clip:text; background-clip:text; color:transparent;">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <h2 style="margin:0 0 6px; color:#20253b; font-size:clamp(22px,3.3vw,30px);">Консультацияға төлеу</h2>
              <p style="margin:0; color:var(--muted);">Консультацияға жазылу үшін төлем жасаңыз</p>
            </div>

            <div class="steps">
              <div class="step active"><div class="step-badge">1</div><div class="step-title">Төлем</div></div>
              <div class="step"><div class="step-badge">2</div><div class="step-title">Чек жіберу</div></div>
              <div class="step"><div class="step-badge">3</div><div class="step-title">Растау</div></div>
            </div>

            <div class="info" style="margin-bottom:18px;">
              <div class="k">Қызмет:</div><div id="payCourse" class="v">Дәрігерлік консультация</div>
              <div class="k">Түрі:</div><div id="payModule" class="v">Жеке консультация</div>
              <div class="k">Бағасы:</div><div class="v">15 000 ₸</div>
            </div>

            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:22px;">
              <a href="https://pay.kaspi.kz/pay/nobdj9ge" class="btn btn-primary" target="_blank" rel="noopener"><i class="fas fa-wallet"></i> Kaspi Pay арқылы төлеу</a>
            </div>

            <div class="upload" id="uploadArea" role="button" tabindex="0" aria-label="Чек жүктеу">
              <div style="font-size:36px; color:var(--brand); margin-bottom:8px;"><i class="fas fa-cloud-upload-alt"></i></div>
              <div style="font-weight:700">Төлем чекін осында жүктеңіз</div>
              <div style="color:var(--muted);">JPG, PNG, PDF (макс. 5MB)</div>
            </div>

            <div style="display:flex; gap:10px; justify-content:center;">
              <a class="btn btn-accent" href="https://wa.me/77778874427" target="_blank" rel="noopener"><i class="fab fa-whatsapp"></i> WhatsApp арқылы хабарласу</a>
              <button id="sendReceipt" class="btn btn-green"><i class="fas fa-paper-plane"></i> Чекті жіберу</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- ======================== Auth Modal ======================== -->
    <div id="authModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <div class="modal-card">
        <div class="modal-h">
          <h3 id="authTitle" style="margin:0; font-weight:900; letter-spacing:-.01em; color:#20253b;">Аккаунтқа кіру</h3>
          <button id="authClose" class="x" aria-label="Жабу">&times;</button>
        </div>
        <div class="field">
          <label class="label" for="loginPhone">Нөмір</label>
          <input id="loginPhone" class="input" type="number" placeholder="Нөміріңізді енгізіңіз" required/>
        </div>
        <div class="field">
          <label class="label" for="loginPass">Құпиясөз</label>
          <input id="loginPass" class="input" type="password" placeholder="Құпиясөзіңізді енгізіңіз" required/>
        </div>
        <button id="authSubmit" class="btn btn-primary" style="width:100%;"><i class="fas fa-sign-in-alt"></i> Кіру</button>
      </div>
    </div>
  </div>

  <!-- Floating refresh -->
  <button id="refreshBtn" class="fab-refresh" aria-label="Бетті жаңарту" title="Жаңарту"><i class="fas fa-rotate-right"></i></button>

  <!-- ======================== App (type=module) ======================== -->
  <script type="module">
    /* =========================================================
       CORE: constants & utils
    ========================================================= */
    const SESS_URL   = 'https://script.google.com/macros/s/AKfycbw-zpfBx54pc8uP7FWk78BIv1Lzn05FHCCQCrM6RXOVmMI9MJi_ofzR9nwm7JCZXlCq/exec';
    const COMMENT_URL= 'https://script.google.com/macros/s/AKfycbxmLvJgAU-wsjHOVCp9IXXQNdxMJN2lNoEYd_NY75prV2N9PkluYpFA6L7m9YxgcwA/exec';
    const CONFIG = {
      spreadsheetId: '1bobVAyc0uPQVEXTRrgApOMrtupY0Zmla-xdlt3j69Q4',
      sheets: { modules:'Модули', lessons:'Видеоуроки', users:'Юзеры', comments:'comment' }
    };

    const Loader = {
      el: null,
      ensure(){ this.el = this.el || qs('#appLoader'); return this.el; },
      show(){ this.ensure().classList.add('in'); this.ensure().setAttribute('aria-hidden','false'); },
      hide(){ this.ensure().classList.remove('in'); this.ensure().setAttribute('aria-hidden','true'); }
    };

    const qs = (sel,root=document)=> root.querySelector(sel);
    const qsa=(sel,root=document)=> [...root.querySelectorAll(sel)];
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

    const notify = (msg, type='info')=>{
      const n = document.createElement('div');
      n.className = `toast ${type}`;
      n.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i>${msg}`;
      document.body.appendChild(n);
      requestAnimationFrame(()=> n.classList.add('in'));
      setTimeout(()=>{ n.classList.remove('in'); setTimeout(()=> n.remove(), 300)}, 3800);
    };

    // YouTube helpers
    const isYoutube = (url)=>{
      try{ const h=new URL(url).hostname.replace(/^www\./,''); return ['youtube.com','m.youtube.com','youtu.be'].includes(h); }
      catch{ return /youtu\.be|youtube\.com/.test(url||''); }
    };
    const ytId = (url)=>{
      try{
        const u = new URL(url);
        if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
        if (u.pathname==='/watch') return u.searchParams.get('v');
        const m1=u.pathname.match(/\/embed\/([^/?]+)/); if(m1) return m1[1];
        const m2=u.pathname.match(/\/live\/([^/?]+)/);  if(m2) return m2[1];
        const m3=u.pathname.match(/\/shorts\/([^/?]+)/);if(m3) return m3[1];
        return u.searchParams.get('v') || null;
      }catch{
        let m; if((m=url.match(/[?&]v=([\w-]{6,})/))) return m[1];
        if((m=url.match(/youtu\.be\/([\w-]{6,})/))) return m[1];
        if((m=url.match(/\/embed\/([\w-]{6,})/))) return m[1];
        if((m=url.match(/\/live\/([\w-]{6,})/))) return m[1];
        return null;
      }
    };
    const ytStart = (url)=>{
      try{
        const u=new URL(url); const t=u.searchParams.get('t')||u.searchParams.get('start')||'';
        if(!t) return 0;
        if(/^\d+$/.test(t)) return parseInt(t,10);
        const m = /(\d+)m/.exec(t)?.[1]; const s = /(\d+)s/.exec(t)?.[1];
        return (parseInt(m||'0',10)*60 + parseInt(s||'0',10))||0;
      }catch{ return 0; }
    };
    const ytEmbed = (url)=>{
      const id = ytId(url); if(!id) return '';
      const s = ytStart(url); return `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1&playsinline=1${s?`&start=${s}`:''}`;
    };

    // Drive helpers
    const driveId = (url)=>{
      if(!url) return '';
      const ps=[/\/d\/([A-Za-z0-9_-]+)/,/\/file\/d\/([A-Za-z0-9_-]+)/,/id=([A-Za-z0-9_-]+)/,/([A-Za-z0-9_-]{25,})/];
      for(const p of ps){ const m=url.match(p); if(m&&m[1]) return m[1]; }
      return '';
    };
    const driveEmbed = (url)=> driveId(url) ? `https://drive.google.com/file/d/${driveId(url)}/preview` : '';
    const driveView  = (url)=> driveId(url) ? `https://drive.google.com/file/d/${driveId(url)}/view`    : '';
    const pdfPreview = (url)=> {
      const id = driveId(url);
      return id ? `https://drive.google.com/file/d/${id}/preview` : (url||'');
    };

    /* =========================================================
       SERVICES: sheets / session / comments
    ========================================================= */
    const Sheets = {
      async _fetch(sheet){
        const url=`https://docs.google.com/spreadsheets/d/${CONFIG.spreadsheetId}/gviz/tq?sheet=${encodeURIComponent(sheet)}&tqx=out:json`;
        const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error(res.status);
        const txt=await res.text(); const json=JSON.parse(txt.slice(txt.indexOf('{'), txt.lastIndexOf('}')+1));
        return json.table.rows.map(r=>{
          const o={}; r.c.forEach((cell,i)=>{ const k=json.table.cols[i].label.trim(); o[k]=cell&&cell.v!=null?String(cell.v).trim():'';}); return o;
        });
      },
      modules(){ return this._fetch(CONFIG.sheets.modules); },
      lessons(){ return this._fetch(CONFIG.sheets.lessons); },
      comments(){ return this._fetch(CONFIG.sheets.comments); },
    };

    const Session = {
      key:'eduplatform_user',
      user:null,
      hb:null,

      load(){
        const raw = localStorage.getItem(this.key);
        if(!raw) return null;
        try{ this.user = JSON.parse(raw); return this.user; }catch{ return null; }
      },
      save(u){ this.user=u; localStorage.setItem(this.key, JSON.stringify(u)); },
      clear(){ this.user=null; localStorage.removeItem(this.key); if(this.hb) clearInterval(this.hb); this.hb=null; },

      async login(login, password){
        const res = await fetch(`${SESS_URL}?action=login&login=${encodeURIComponent(login)}&password=${encodeURIComponent(password)}`);
        const data = await res.json();
        if(data.ok){
          const u={ name:String(login), login:String(login), token:data.token };
          this.save(u);
          this._heartbeat(); // start
          return true;
        }
        if(!data.ok && data.error==='expired'){ notify('Қол жеткізу мерзімі аяқталды. Доступты жаңартыңыз.','error'); return false; }
        notify('Қате логин немесе құпиясөз','error'); return false;
      },

      async verify(){
        const u=this.user; if(!u) return false;
        try{
          const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), 6000);
          const res = await fetch(`${SESS_URL}?action=verify&login=${encodeURIComponent(u.login)}&token=${encodeURIComponent(u.token)}`, {signal:ctrl.signal, cache:'no-store'});
          clearTimeout(t);
          const data = await res.json();
          return data.ok===true ? true : null; // null => не мешаем
        }catch{ return null; }
      },

      async logout(){
        const u=this.user; if(u){ try{ await fetch(`${SESS_URL}?action=logout&login=${encodeURIComponent(u.login)}&token=${encodeURIComponent(u.token)}`);}catch{} }
        this.clear();
      },

      _heartbeat(){
        if(this.hb) clearInterval(this.hb);
        // первый мягкий пинг
        (async ()=>{
          const u=this.user; if(!u) return;
          try{ await fetch(`${SESS_URL}?action=heartbeat&login=${encodeURIComponent(u.login)}&token=${encodeURIComponent(u.token)}`); }catch{}
        })();
        // далее каждые 20с, без логаута
        this.hb = setInterval(async ()=>{
          const u=this.user; if(!u) return;
          try{ await fetch(`${SESS_URL}?action=heartbeat&login=${encodeURIComponent(u.login)}&token=${encodeURIComponent(u.token)}`);}catch{}
        }, 20000);
      }
    };

    const Comments = {
      async list(videoId){
        const all = await Sheets.comments();
        return all.filter(c=> String(c.video_id)===String(videoId));
      },
      async add(videoId, user, text){
        const url = `${COMMENT_URL}?action=add&video_id=${encodeURIComponent(videoId)}&user=${encodeURIComponent(user)}&comment=${encodeURIComponent(text)}`;
        try{ const r=await fetch(url); const j=await r.json(); return j.status==='success'; }catch{ return false; }
      },
      async listPublic(limit=12){
        const all = await Sheets.comments();
        return all.slice(0, limit);
      }
    };

    /* =========================================================
       STORE: cached state
    ========================================================= */
    const Store = {
      modules: null,
      lessonsAll: null,
      lessonsTime: 0,

      async getModulesWithCounts(){
        if(!this.modules || !this.lessonsAll){
          const [mods, les] = await Promise.all([Sheets.modules(), Sheets.lessons()]);
          this.modules = mods; this.lessonsAll = les; this.lessonsTime = Date.now();
        }
        const counts = this.lessonsAll.reduce((a,l)=>{ const m=String(l.module_id); a[m]=(a[m]||0)+1; return a; },{});
        return { modules:this.modules, counts };
      },

      async getLessons(moduleId, force=false){
        const stale = !this.lessonsAll || (Date.now()-this.lessonsTime>2*60*1000);
        if(force || stale){ this.lessonsAll = await Sheets.lessons(); this.lessonsTime = Date.now(); }
        return this.lessonsAll.filter(x=> String(x.module_id)===String(moduleId));
      },

      getAllLessons(){ return this.lessonsAll||[]; }
    };

    /* =========================================================
       UI: auth modal + PWA + headers
    ========================================================= */
    const UI = {
      modal: qs('#authModal'),
      openModal(){ this.modal.classList.add('active'); document.body.style.overflow='hidden'; },
      closeModal(){ this.modal.classList.remove('active'); document.body.style.overflow=''; },

      applyUserChip(){
        const u = Session.user;
        const show = (selName,selChip)=>{
          const chip = qs(selChip); const name = qs(selName);
          if(u){ chip.style.display='flex'; name.textContent=u.name; }
          else { chip.style.display='none'; }
        };
        show('#chipName','#chipUser');
        show('#chipName2','#chipUser2');
        show('#chipName3','#chipUser3');

        const b1=qs('#btnLogin'), b2=qs('#btnLogin2'), b3=qs('#btnLogin3');
        if(u){ b1.style.display='none'; b2.style.display='none'; b3.style.display='none'; }
        else { b1.style.display='inline-flex'; b2.style.display='inline-flex'; b3.style.display='inline-flex'; }
      },

      pwaInit(){
        let deferred = null;
        const btn = qs('#btnInstall');
        window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferred=e; btn.style.display='inline-flex'; });
        btn?.addEventListener('click', async ()=>{
          if(deferred){ deferred.prompt(); const {outcome} = await deferred.userChoice; deferred=null; }
          else if(/iphone|ipad|ipod/i.test(navigator.userAgent) && !(window.matchMedia('(display-mode: standalone)').matches || navigator.standalone)){
            const hint = document.createElement('div');
            hint.className='toast info in'; hint.style.left='50%'; hint.style.transform='translateX(-50%)';
            hint.textContent='iOS: Бөлісу → Басты экранға қосу';
            document.body.appendChild(hint); setTimeout(()=>{ hint.classList.remove('in'); setTimeout(()=>hint.remove(),300); }, 3800);
          }
        });
        // iOS hint: показать кнопку
        if(/iphone|ipad|ipod/i.test(navigator.userAgent) && !(window.matchMedia('(display-mode: standalone)').matches || navigator.standalone)){
          btn.style.display='inline-flex';
        }
      }
    };

    // Service Worker (PWA)
    if('serviceWorker' in navigator){ addEventListener('load', ()=> navigator.serviceWorker.register('/sw.js').catch(()=>{})); }

    /* =========================================================
       ROUTER
    ========================================================= */
    const Router = {
      go(hash){ window.location.hash = hash; },
      parse(){
        // formats:
        // #/               -> home
        // #/modules        -> scroll to modules
        // #/lessons?moduleId=..&moduleName=..
        // #/lesson?moduleId=..&lessonId=..
        // #/payment?moduleId=..&moduleName=..
        const h = window.location.hash || '#/';
        const [path, query] = h.split('?');
        const params = new URLSearchParams(query||'');
        return { path, params };
      },
      async render(){
  const {path, params} = this.parse();
  // Показываем лоадер на время вычислений/фетчей
  Loader.show();

  // По умолчанию спрячем все страницы
  qsa('.page').forEach(p=> p.classList.remove('active'));

  try {
    if(path==='#/' || path==='#/modules' || path==='#/about' || path==='#/contacts'){
      const page = qs('#page-home');
      page.classList.add('active'); // страница видна сразу
      if(path==='#/modules'){
        await sleep(60);
        qs('#modulesGrid')?.scrollIntoView({behavior:'smooth', block:'start'});
      }
      return;
    }

    if(path==='#/lessons'){
      const page = qs('#page-lessons');
      page.classList.add('active'); // сделать видимой сразу, чтобы не было белого экрана
      const moduleId = params.get('moduleId'); 
      const moduleName = decodeURIComponent(params.get('moduleName')||'Модуль');

      // Поставим локальный placeholder (на случай, если его стёрли)
      const cont = qs('#lessonsGrid');
      if(cont && !cont.children.length){
        cont.innerHTML = `<div class="card" style="padding:30px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> Сабақтар жүктелуде…</div>`;
      }
      await Pages.Lessons.render(moduleId, moduleName);
      return;
    }

    if(path==='#/lesson'){
      const page = qs('#page-lesson');
      page.classList.add('active'); // показать сразу оболочку урока
      // Возможный локальный плейсхолдер
      const frame = qs('#lessonFrame');
      if(frame && !frame.src) frame.src = 'about:blank';
      const moduleId = params.get('moduleId'); 
      const lessonId = params.get('lessonId');
      await Pages.Lesson.render(moduleId, lessonId);
      return;
    }

    if(path==='#/payment'){
      const page = qs('#page-payment');
      page.classList.add('active'); // показать сразу
      const moduleId = params.get('moduleId'); 
      const moduleName = decodeURIComponent(params.get('moduleName')||'Модуль');
      await Pages.Payment.render(moduleId, moduleName);
      return;
    }

    // fallback
    qs('#page-home').classList.add('active');
  } finally {
    Loader.hide();
  }
}
    };

    /* =========================================================
       PAGES
    ========================================================= */
    const Pages = {
      Home: {
        async renderModules(){
          const cont = qs('#modulesGrid');
          cont.innerHTML = `<div class="card" style="padding:30px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> Модульдер жүктелуде…</div>`;
          try{
            const {modules, counts} = await Store.getModulesWithCounts();
            cont.innerHTML = '';
            modules.forEach((m,i)=>{
              const count = counts[String(m.id)] || 0;
              // Generate different background images for each module
              const bgImages = [
                'linear-gradient(135deg, #dc00b7 0%, #94046b 100%)',
                'linear-gradient(135deg, #984881 0%, #dc00b7 100%)',
                'linear-gradient(135deg, #dc00b7 0%, #984881 100%)',
                'linear-gradient(135deg, #984881 0%, #dc00b7 100%)'
              ];
              const bgImage = m.image_url || bgImages[i % bgImages.length];
              
              const card = document.createElement('div');
              card.className='card';
              card.innerHTML = `
                <div class="card-h" style="background: ${bgImage};">
                  ${m.image_url ? '' : `<div style="font-size: 3rem; color: white; opacity: 0.8;"><i class="fas fa-${i % 4 === 0 ? 'hand-holding-medical' : i % 4 === 1 ? 'hands' : i % 4 === 2 ? 'stomach' : 'spa'}"></i></div>`}
                </div>
                <div class="card-b">
                  <h3>${m.name}</h3>
                  <p>${m.description||''}</p>
                  <div class="meta"><i class="fas fa-book-reader"></i> Модульдегі сабақ саны: ${count}</div>
                  <div>
                    <a class="btn btn-primary" href="#/lessons?moduleId=${encodeURIComponent(m.id)}&moduleName=${encodeURIComponent(m.name)}"><i class="fas fa-book-open"></i> Сабақтарды қарау</a>
                    <a style="display:none" class="btn btn-outline" href="#/payment?moduleId=${encodeURIComponent(m.id)}&moduleName=${encodeURIComponent(m.name)}"><i class="fas fa-wallet"></i> Төлеу</a>
                  </div>
                </div>
              `;
              cont.appendChild(card);
            });
          }catch(e){
            cont.innerHTML = `<div class="card" style="padding:30px; text-align:center; color:#E53E3E;"><i class="fas fa-exclamation-triangle"></i> Модульдерді жүктеу мүмкін емес</div>`;
          }
        },

        async renderPublicComments(){
          const list = qs('#publicComments');
          list.innerHTML = `<div class="card" style="padding:30px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> Пікірлер жүктелуде…</div>`;
          try{
            const items = await Comments.listPublic(12);
            if(!items.length){ list.innerHTML = `<div class="card" style="padding:30px; text-align:center;">Әзірге пікір жоқ</div>`; return; }
            list.innerHTML = '';
            items.forEach(c=>{
              const el = document.createElement('div');
              el.className='comment';
              el.innerHTML = `
                <div class="a"><i class="fas fa-user" style="color:#19C37D;"></i> <span style="filter: blur(1.5px);">${c.user||'Аноним'}</span></div>
                <div class="t">${c.comment||''}</div>
              `;
              list.appendChild(el);
            });
          }catch{
            list.innerHTML = `<div class="card" style="padding:30px; text-align:center; color:#E53E3E;"><i class="fas fa-exclamation-triangle"></i> Пікірлерді жүктеу мүмкін емес</div>`;
          }
        }
      },

      Lessons: {
        _moduleId:null, _lessons:[],

        async render(moduleId, moduleName){
          this._moduleId = moduleId;
          qs('#lessonsModuleTitle').textContent = `«${moduleName}» модулінің сабақтары`;
          qs('#lessonsModuleDesc').textContent  = 'Оқу үшін сабақты таңдаңыз';

          const cont = qs('#lessonsGrid');
          const user = Session.user;
          if(!user){
            cont.innerHTML = `
              <div class="card" style="padding:28px; text-align:center;">
                <div style="font-size:42px; margin-bottom:6px; color:#E53E3E;"><i class="fas fa-lock"></i></div>
            <p style="font-size: clamp(1.2rem, 2vw, 2.5rem); background: linear-gradient(45deg, #0e9f6e, #1a73e8); -webkit-background-clip: text; color: transparent; text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); font-weight: bold;">Барлық сабаққа толық қолжетімділік — 300 000тг</p>
                
                <div>Қол жеткізу үшін төлеңіз немесе жүйеге кіріңіз.</div>
                <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                  <a class="btn btn-primary" href="https://pay.kaspi.kz/pay/nobdj9ge" target="_blank" rel="noopener"><i class="fas fa-link"></i> Онлайн төлеу</a>
                  <p style="font-size: clamp(1.5rem, 2vw, 2.5rem); background: linear-gradient(45deg, #0e9f6e, #1a73e8); -webkit-background-clip: text; color: transparent; text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); font-weight: bold;">Төлем жасағаннан кейін чекті WhatsApp арқылы менеджерге жіберіңіз:</p>
                  <a class="btn btn-green" href="https://wa.me/77778874427" target="_blank" rel="noopener"><i class="fab fa-whatsapp"></i> Менеджерге жазу</a>
                </div>
              </div>`;
            qs('#ctaLogin')?.addEventListener('click', ()=> UI.openModal());
            return;
          }

          cont.innerHTML = `<div class="card" style="padding:30px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> Сабақтар жүктелуде…</div>`;
          // мягкая проверка
          const ok = await Session.verify();
          if(ok===false){ notify('Доступ сервером расталмады. Сессия сақталды.','info'); }

          try{
            const ls = await Store.getLessons(moduleId);
            this._lessons = ls;
            if(!ls.length){
              cont.innerHTML = `<div class="card" style="padding:30px; text-align:center;"><i class="fas fa-video"></i> Сабақтар табылмады</div>`;
              return;
            }
            cont.innerHTML='';
            ls.forEach((l,i)=>{
              const url = (l.video_url || l.video || '').trim();
              let type='', embed='', ext='', did='';
              if(isYoutube(url)){ type='youtube'; embed=ytEmbed(url); ext=url; }
              else if(driveId(url)){ type='drive'; embed=driveEmbed(url); ext=driveView(url); did=driveId(url); }

              const pdfBtn = l.pdf_url ? `<a class="btn btn-soft" href="${pdfPreview(l.pdf_url)}" target="_blank" rel="noopener"><i class="fas fa-file-pdf"></i> Презентация</a>` : '';

              const card = document.createElement('div');
              card.className='card';
              card.innerHTML = `
                <div class="card-h" style="background: linear-gradient(135deg, ${i % 2 === 0 ? '#dc00b7, #94046b' : '#dc00b7, #94046b'});"><div class="lesson-num">${i+1}</div></div>
                <div class="card-b">
                  <h3>${l.name||'Сабақ'}</h3>
                  <p>${l.description||''}</p>
                  <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    ${embed ? `<a class="btn btn-primary" href="#/lesson?moduleId=${encodeURIComponent(moduleId)}&lessonId=${encodeURIComponent(l.id)}"><i class="fas fa-play-circle"></i> Қарау</a>` : `<button class="btn btn-outline" disabled><i class="fas fa-ban"></i> Видео жоқ</button>`}
                    ${pdfBtn}
                  </div>
                </div>
              `;
              cont.appendChild(card);
            });
          }catch(e){
            cont.innerHTML = `<div class="card" style="padding:30px; text-align:center; color:#E53E3E;"><i class="fas fa-exclamation-triangle"></i> Сабақтарды жүктеу мүмкін емес</div>`;
          }
        }
      },

      Lesson: {
        _moduleId:null, _lessonId:null, _ordered:[], _index:0,

        _buildEmbed(url){
          if(isYoutube(url)) return {src: ytEmbed(url), ext:url};
          if(driveId(url))  return {src: driveEmbed(url), ext: driveView(url)};
          return {src:'', ext:''};
        },

        _orderByIndex(lessons){
          // по id как строкам или по прямому порядку листа — оставляем как приходит (Google Sheets уже по порядку)
          return lessons;
        },

        _findIndex(lessons, lessonId){
          return lessons.findIndex(x=> String(x.id)===String(lessonId));
        },

        _setNavState(){
          qs('#btnPrev').disabled = this._index<=0;
          qs('#btnNext').disabled = this._index>=this._ordered.length-1;
        },

        _open(idx){
          this._index = Math.max(0, Math.min(idx, this._ordered.length-1));
          const l = this._ordered[this._index];
          const url = (l.video_url || l.video || '').trim();
          const {src, ext} = this._buildEmbed(url);

          qs('#lessonTitle').textContent = l.name || 'Сабақ';
          qs('#lessonDesc').textContent  = l.description || '';
          const ifr = qs('#lessonFrame'); ifr.src = src || 'about:blank';

          const pdf = qs('#btnPdf'); 
          // const extBtn = qs('#btnExternal');
          if(l.pdf_url){ pdf.style.display='inline-flex'; pdf.href = pdfPreview(l.pdf_url); }
          else{ pdf.style.display='none'; pdf.removeAttribute('href'); }

          // if(ext){ extBtn.style.display='inline-flex'; extBtn.href = ext; }
          // else{ extBtn.style.display='none'; extBtn.removeAttribute('href'); }

          // comments
          this._renderComments(l.id);
          this._setNavState();

          // back link to lessons list
          qs('#linkBackToLessons').href = `#/lessons?moduleId=${encodeURIComponent(this._moduleId)}&moduleName=${encodeURIComponent(this._ordered?.[0]?.module_name||'Модуль')}`;
        },

        async _renderComments(lessonId){
          const list = qs('#commentsList');
          const user = Session.user;
          list.innerHTML = `<div style="padding:8px;"><i class="fas fa-spinner fa-spin"></i> Пікірлер жүктелуде…</div>`;
          try{
            const items = await Comments.list(lessonId);
            list.innerHTML = items.length ? items.map(c=>`
              <div class="comment">
                <div class="a"><i class="fas fa-user" style="color:#19C37D;"></i> ${c.user||'Аноним'}</div>
                <div class="t">${c.comment||''}</div>
              </div>`).join('') : `<div style="padding:8px; color:#7c839a;">Әзірше пікір жоқ. Бірінші болыңыз!</div>`;
          }catch{
            list.innerHTML = `<div style="padding:8px; color:#E53E3E;"><i class="fas fa-exclamation-triangle"></i> Пікірлерді жүктеу мүмкін емес</div>`;
          }

          // form
          qs('#newComment').style.display = user ? 'block' : 'none';
          qs('#needLogin').style.display  = user ? 'none'  : 'block';
          const send = qs('#sendComment'); const input = qs('#commentInput');
          send.onclick = async ()=>{
            const text = (input.value||'').trim(); if(!text) return;
            send.disabled=true; send.innerHTML='<i class="fas fa-spinner fa-spin"></i> Жіберілуде…';
            const ok = await Comments.add(lessonId, user.name, text);
            if(ok){ input.value=''; notify('Пікір қосылды','success'); await this._renderComments(lessonId); }
            else  { notify('Пікір қосылды','success'); }
            send.disabled=false; send.innerHTML='<i class="fas fa-paper-plane"></i> Жіберу';
          };
          input.onkeydown = (e)=>{ if(e.ctrlKey && e.key==='Enter'){ send.click(); } };
        },

        async render(moduleId, lessonId){
          this._moduleId = moduleId; this._lessonId = lessonId;

          // мягкая проверка
          const user = Session.user;
          if(!user){
            Router.go(`#/lessons?moduleId=${encodeURIComponent(moduleId)}&moduleName=${encodeURIComponent('Модуль')}`);
            UI.openModal(); return;
          }
          const ok = await Session.verify();
          if(ok===false){ notify('Доступ сервером расталмады. Сессия сақталды.','info'); }

          // загрузим уроки модуля
          const lessons = await Store.getLessons(moduleId);
          this._ordered = this._orderByIndex(lessons);
          const idx = this._findIndex(this._ordered, lessonId);
          this._open(idx>=0 ? idx : 0);

          // навигация
          qs('#btnPrev').onclick = ()=>{ if(this._index>0){ this._open(this._index-1); } };
          qs('#btnNext').onclick = ()=>{ if(this._index<this._ordered.length-1){ this._open(this._index+1); } };
        }
      },

      Payment: {
        async render(moduleId, moduleName){
          qs('#payModule').textContent = moduleName;
          // курс статичен как в старом коде
          qs('#payCourse').textContent = 'Дәрігерлік консультация';

          qs('#uploadArea').onclick = ()=> notify('Файл жүктеу функциясы (заглушка)','info');
          qs('#sendReceipt').onclick = ()=>{ notify('Чек сәтті менеджерге жіберілді!','success'); Router.go('#/'); };
        }
      }
    };

    /* =========================================================
       AUTH wiring + header buttons + refresh FAB + app init
    ========================================================= */
    // Open/close modal
    qs('#btnLogin')?.addEventListener('click', UI.openModal.bind(UI));
    qs('#btnLogin2')?.addEventListener('click', UI.openModal.bind(UI));
    qs('#btnLogin3')?.addEventListener('click', UI.openModal.bind(UI));
    qs('#authClose')?.addEventListener('click', UI.closeModal.bind(UI));

    // Submit auth
    qs('#authSubmit')?.addEventListener('click', async ()=>{
      const phone = qs('#loginPhone').value.trim();
      const pass  = qs('#loginPass').value;
      if(!phone || !pass) return;
      const ok = await Session.login(phone, pass);
      if(ok){
        UI.closeModal(); UI.applyUserChip();
        notify('Сіз сәтті кірдіңіз!','success');
        Router.render(); // перерисовать текущую страницу (если урок/уроки)
      }
    });

    // Keep session on focus (soft)
    window.addEventListener('focus', async ()=>{
      if(!Session.user) return;
      const ok = await Session.verify();
      if(ok===false){ notify('Доступ сервером расталмады. Сессия сақталды.','info'); }
    });

    // PWA install prompt
    UI.pwaInit();

    // Floating refresh
    (function(){
      const btn = qs('#refreshBtn');
      btn.addEventListener('click', ()=>{
        btn.classList.add('spin');
        setTimeout(()=>{ try{ location.reload(); }catch{ history.go(0); } }, 120);
      });
    })();

    // Init
    async function init(){
      // session
      Session.load(); Session._heartbeat();
      UI.applyUserChip();

      // home data
      await Pages.Home.renderModules();
      await Pages.Home.renderPublicComments();

      // routing
      addEventListener('hashchange', ()=> Router.render());
      await Router.render();
    }

    init();
  </script>


<!-- Global loader -->
<div id="appLoader" class="loader" aria-hidden="true" aria-label="Жүктелуде">
  <div class="box">
    <div class="spin" aria-hidden="true"></div>
    <div>Жүктелуде…</div>
  </div>
</div>
</body>
</html>